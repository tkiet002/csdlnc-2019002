----1.Create a database.
USE MASTER
GO
IF EXISTS(SELECT NAME FROM SYSDATABASES WHERE NAME ='DB1')
	DROP DATABASE DB1
GO
CREATE DATABASE DB1
GO
USE DB1
GO
----2.Create tables
CREATE TABLE MATHANG
(
	MSMH		CHAR(10)		NOT NULL,
	TENMH		NVARCHAR(100)	NOT NULL,
	DONGIA		FLOAT			NULL,
	DVT			NVARCHAR(20)	NULL,			
	CONSTRAINT PK_MATHANG PRIMARY KEY(MSMH)
);
CREATE TABLE KHACHHANG
(
	MSKH		CHAR(10)		NOT NULL,
	TENKH		NVARCHAR(50)	NOT NULL,
	DIACHI		NVARCHAR(100)	NOT NULL,
	DIENTHOAI	VARCHAR(10)		NULL,
	CONSTRAINT PK_KHACHHANG PRIMARY KEY(MSKH)
);
CREATE TABLE NHANVIEN
(
	MSNV		CHAR(10)		NOT NULL,
	TENNV		NVARCHAR(50)	NOT NULL,
	DIACHI		NVARCHAR(100)	NOT NULL,
	CMND		CHAR(15)		NOT NULL,
	DIENTHOAI	VARCHAR(10)		NULL,
	NGAYSINH	DATETIME		NOT NULL,
	CONSTRAINT PK_NHANVIEN PRIMARY KEY(MSNV)
);
CREATE TABLE HOADON
(
	MSHD		CHAR(10)		NOT NULL,
	NGAYHD		DATETIME		NOT NULL,
	MSKH		CHAR(10)		NULL,
	MSNV		CHAR(10)		NULL,
	CONSTRAINT PK_HOADON PRIMARY KEY(MSHD)
);
CREATE TABLE CT_HOADON
(
	MSHD		CHAR(10)		NOT NULL,
	MSMH		CHAR(10)		NOT NULL,
	SOLUONG		INT				NULL,
	CONSTRAINT PK_CT_HOADON PRIMARY KEY(MSHD, MSMH)
);

---3.Create foreign keys
---------------------------HOADON --> KHACHHANG, NHANVIEN
ALTER TABLE HOADON
	ADD CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY(MSKH) REFERENCES KHACHHANG(MSKH),
		CONSTRAINT FK_HOADON_NHANVIEN FOREIGN KEY(MSNV) REFERENCES NHANVIEN(MSNV)

---------------------------CT_HOADON --> MATHANG, HOADON
ALTER TABLE CT_HOADON
	ADD CONSTRAINT FK_CT_HOADON_MATHANG FOREIGN KEY(MSMH) REFERENCES MATHANG(MSMH),
		CONSTRAINT FK_CT_HOADON_HOADON FOREIGN KEY(MSHD) REFERENCES HOADON(MSHD)

---4.Insert data into the tables
---TẠO DỮ LIỆU MẶT HÀNG
INSERT INTO MATHANG(MSMH,TENMH,DONGIA,DVT) VALUES (1,'HDD20',10,N'CÁI')
INSERT INTO MATHANG(MSMH,TENMH,DONGIA,DVT) VALUES (2,'HDD40',20,N'CÁI')
INSERT INTO MATHANG(MSMH,TENMH,DONGIA,DVT) VALUES (3,'MBPII',10,N'CÁI')
INSERT INTO MATHANG(MSMH,TENMH,DONGIA,DVT) VALUES (4,'SDD512',15,N'CÁI')

---TẠO DỮ LIỆU KHÁCH  HÀNG	
INSERT INTO KHACHHANG(MSKH,TENKH,DIACHI,DIENTHOAI) 
VALUES (1,N'NGUYỄN VĂN A',N'16/11 BÙI THỊ XUÂN F3 TÂN BÌNH','0903648211')
INSERT INTO KHACHHANG(MSKH,TENKH,DIACHI,DIENTHOAI) 
VALUES (2,N'NGUYỄN VĂN B',N'16/11 LẠC LONG QUÂN F12 TB','0903648154')
INSERT INTO KHACHHANG(MSKH,TENKH,DIACHI,DIENTHOAI) 
VALUES (3,N'NGUYỄN VĂN M',N'16/11 HUỲNH VĂN BÁNH F3 PN','0903648218')
INSERT INTO KHACHHANG(MSKH,TENKH,DIACHI,DIENTHOAI) 
VALUES (4,N'NGUYỄN VĂN C',N'16/11 BÙI THỊ XUÂN F3 TB','0903648812')

---TẠO DỮ LIỆU NHÂN VIÊN
SET DATEFORMAT YMD

INSERT INTO NHANVIEN(MSNV,TENNV,DIACHI,CMND,DIENTHOAI,NGAYSINH)
VALUES(1,N'PHẠM VĂN THIỆN',N'16 BTX F3 TB','5632987546','0903648214','1985-09-09')
INSERT INTO NHANVIEN(MSNV,TENNV,DIACHI,CMND,DIENTHOAI,NGAYSINH)
VALUES(2,N'NGUYỄN ĐÌNH HOÀNG',N'16 BTX F3 TB','5672917546','0903648252','1980-05-17')	
INSERT INTO NHANVIEN(MSNV,TENNV,DIACHI,CMND,DIENTHOAI,NGAYSINH)
VALUES(3,N'NGUYỄN TRUNG KIÊN',N'16 BTX F3 TB','563981746','0903649872','1979-10-16')	
INSERT INTO NHANVIEN(MSNV,TENNV,DIACHI,CMND,DIENTHOAI,NGAYSINH)
VALUES(4,N'NGUYỄN THÁI HÒA',N'12/65 THU DUC','1832987546','0903606542' ,'1981-04-01')	

---TẠO DỮ LIỆU HÓA ĐƠN
INSERT INTO HOADON(MSHD,NGAYHD,MSKH,MSNV)
	VALUES(1,'2019-01-01',1,1)
INSERT INTO HOADON(MSHD,NGAYHD,MSKH,MSNV)
	VALUES(2,'2019-01-02',2,2)
INSERT INTO HOADON(MSHD,NGAYHD,MSKH,MSNV)
	VALUES(3,'2019-01-01',1,2)
INSERT INTO HOADON(MSHD,NGAYHD,MSKH,MSNV)
	VALUES(4,'2019-01-01',1,1)

---TẠO DỮ LIỆU CT HÓA ĐƠN	
INSERT INTO CT_HOADON(MSHD,MSMH,SOLUONG)
	VALUES(1,1,1)
INSERT INTO CT_HOADON(MSHD,MSMH,SOLUONG)
	VALUES(1,3,2)
INSERT INTO CT_HOADON(MSHD,MSMH,SOLUONG)
	VALUES(2,1,1)
INSERT INTO CT_HOADON(MSHD,MSMH,SOLUONG)
	VALUES(2,2,3)
INSERT INTO CT_HOADON(MSHD,MSMH,SOLUONG)
	VALUES(2,4,1)
INSERT INTO CT_HOADON(MSHD,MSMH,SOLUONG)
	VALUES(3,2,4)
INSERT INTO CT_HOADON(MSHD,MSMH,SOLUONG)
	VALUES(4,1,6)
INSERT INTO CT_HOADON(MSHD,MSMH,SOLUONG)
	VALUES(4,3,10)
INSERT INTO CT_HOADON(MSHD,MSMH,SOLUONG)
	VALUES(4,2,15)

----4.Perform queries
/*
	3.5. Đứng tại Server1 (DB1), thực hiện công việc sau trên Server2 (DB2)
*/

/*
	Syntax:
			Cách 1: DB with DB
					SELECT
					FROM	[TÊN DATABASE].dbo.[TÊN BẢNG]	
					...
			Cách 2: IP
					SELECT
					FROM	[IP].[TÊN DATABASE].dbo.[TÊN BẢNG]
					...
*/

/*
	Câu 1: Liệt kê các hóa đơn sau ngày 01/01/2019.
*/
SELECT	hd.*
FROM	DB2.dbo.HOADON hd
WHERE	hd.NGAYHD>'01/01/2019'

SELECT	hd.*
FROM	DB1.dbo.HOADON hd
WHERE	hd.NGAYHD>'01/01/2019'

/*
	Câu 2: Liệt kê các hóa đơn của khách hàng có tên ‘Nguyễn Văn A’.
*/
SELECT	hd.MSHD, hd.NGAYHD, kh.TENKH, mh.MSMH, mh.TENMH, 
		ct.SOLUONG, mh.DONGIA, ct.SOLUONG * mh.DONGIA as THANHTIEN
FROM	DB2.dbo.HOADON hd, DB2.dbo.KHACHHANG kh, DB2.dbo.CT_HOADON ct, DB2.dbo.MATHANG mh
WHERE	hd.MSKH = kh.MSKH and
		hd.MSHD = ct.MSHD and
		ct.MSMH = mh.MSMH and
		kh.TENKH like N'%Nguyễn Văn A%'

/*
	Câu 3: Liệt kê các chi tiết hóa đơn của khách hàng tên ‘Nguyễn Văn A’ mua mặt hàng ‘HDD20’
*/
SELECT	hd.MSHD, hd.NGAYHD, 
		ct.MSMH, ct.SOLUONG, mh.DONGIA, ct.SOLUONG*mh.DONGIA as THANHTIEN
FROM	DB2.dbo.HOADON hd, DB2.dbo.CT_HOADON ct, DB2.dbo.MATHANG mh
WHERE	hd.MSHD = ct.MSHD and
		ct.MSMH = mh.MSMH and
		hd.MSKH in	(
						SELECT	kh.MSKH
						FROM	DB2.dbo.KHACHHANG kh
						WHERE	kh.TENKH LIKE N'%Nguyễn Văn A%'
					)	and
		mh.TENMH = 'HDD20'

/*
	Câu 4: Hãy làm các công việc trên Server1(DB1) và so sánh thời gian thực hiện Server2(DB2).
*/
SELECT	hd.MSHD, hd.NGAYHD, 
		ct.MSMH, ct.SOLUONG, mh.DONGIA, ct.SOLUONG*mh.DONGIA as THANHTIEN,
		Getdate() as Thoigian
FROM	DB2.dbo.HOADON hd, DB2.dbo.CT_HOADON ct, DB2.dbo.MATHANG mh
WHERE	hd.MSHD = ct.MSHD and
		ct.MSMH = mh.MSMH and
		hd.MSKH in	(
						SELECT	kh.MSKH
						FROM	DB2.dbo.KHACHHANG kh
						WHERE	kh.TENKH LIKE N'%Nguyễn Văn A%'
					)	and
		mh.TENMH = 'HDD20'
---------------------------------------------------------------------------
SELECT	hd.MSHD, hd.NGAYHD, 
		ct.MSMH, ct.SOLUONG, mh.DONGIA, ct.SOLUONG*mh.DONGIA as THANHTIEN,
		Getdate() as Thoigian
FROM	DB1.dbo.HOADON hd, DB1.dbo.CT_HOADON ct, DB1.dbo.MATHANG mh
WHERE	hd.MSHD = ct.MSHD and
		ct.MSMH = mh.MSMH and
		hd.MSKH in	(
						SELECT	kh.MSKH
						FROM	DB1.dbo.KHACHHANG kh
						WHERE	kh.TENKH LIKE N'%Nguyễn Văn A%'
					)	and
		mh.TENMH = 'HDD20'

/*
	Câu 5: Cập nhật số điện thoại khách hàng có mskh=4 với số điện thoại mới: 0908258003
*/
UPDATE	DB2.dbo.KHACHHANG
SET		DIENTHOAI = '0908258003'
WHERE	MSKH = '4'

SELECT * FROM DB2.dbo.KHACHHANG

/*
	Câu 6: Cập nhật dây chuyền mskh = 2 và mshd = 2 với mshd mới là 5 trên 2 table HOADON và CT_HOADON
*/

	IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME = 'PR_CAPNHATCAU6')
		DROP PROC PR_CAPNHATCAU6
	GO

	CREATE PROC PR_CAPNHATCAU6
	(
		@MSKH		CHAR(10),
		@MSHD		CHAR(10)
	)AS
	BEGIN
			ALTER TABLE DB1.dbo.HOADON DISABLE TRIGGER ALL;
			ALTER TABLE DB1.dbo.CT_HOADON DISABLE TRIGGER ALL;
			ALTER TABLE DB2.dbo.HOADON DISABLE TRIGGER ALL;
			ALTER TABLE DB2.dbo.CT_HOADON DISABLE TRIGGER ALL;
			ALTER TABLE DB1.dbo.CT_HOADON NOCHECK  CONSTRAINT  FK_CT_HOADON_HOADON;
			ALTER TABLE DB2.dbo.CT_HOADON NOCHECK  CONSTRAINT  FK_CT_HOADON_HOADON;
			BEGIN TRAN TR
			IF EXISTS(SELECT MSKH FROM DB1.dbo.HOADON HD WHERE HD.MSKH = @MSKH)
			BEGIN
				IF EXISTS(SELECT MSHD FROM DB1.dbo.HOADON HD WHERE HD.MSHD = @MSHD)
				BEGIN
					IF EXISTS(SELECT CT.MSHD FROM DB1.dbo.CT_HOADON CT WHERE CT.MSHD = @MSHD)
					BEGIN
						IF EXISTS(SELECT MSKH FROM DB2.dbo.HOADON HD WHERE HD.MSKH = @MSKH)
						BEGIN
							IF EXISTS(SELECT MSHD FROM DB2.dbo.HOADON HD WHERE HD.MSHD = @MSHD)
							BEGIN
								IF EXISTS(SELECT CT.MSHD FROM DB2.dbo.CT_HOADON CT WHERE CT.MSHD = @MSHD)
								BEGIN
									UPDATE	DB1.dbo.HOADON
									SET		MSHD = 5
									WHERE	MSHD = @MSHD AND MSKH = @MSKH;

									UPDATE DB2.dbo.HOADON
									SET		MSHD = 5
									WHERE	MSHD = @MSHD AND MSKH = @MSKH;

									UPDATE	DB1.dbo.CT_HOADON
									SET		MSHD = 5
									WHERE	MSHD = @MSHD;

									UPDATE DB2.dbo.CT_HOADON
									SET		MSHD = 5
									WHERE	MSHD = @MSHD;

									PRINT N'CAP NHAT THANH CONG'
												ALTER TABLE DB1.dbo.HOADON ENABLE TRIGGER ALL;
												ALTER TABLE DB1.dbo.CT_HOADON ENABLE TRIGGER ALL;
												ALTER TABLE DB2.dbo.HOADON ENABLE TRIGGER ALL;
												ALTER TABLE DB2.dbo.CT_HOADON ENABLE TRIGGER ALL;
												ALTER TABLE DB1.dbo.CT_HOADON CHECK  CONSTRAINT  FK_CT_HOADON_HOADON;
												ALTER TABLE DB2.dbo.CT_HOADON CHECK  CONSTRAINT  FK_CT_HOADON_HOADON;
									COMMIT TRAN TR
								END		
							END
						END
					END
				END
			END
			ELSE
			BEGIN
				PRINT N'LOI KHONG CO MA SO KHACH HANG HOAC MA SO HD NAY' + @MSKH + ' ' + @MSHD
				ROLLBACK TRAN TR
			END
		END
		GO
		
		EXEC PR_CAPNHATCAU6 @MSKH = '2' , @MSHD = '2';
		SELECT * FROM HOADON
/*
	Câu 7: Tạo Stored Procedure thêm khách hàng mới vào Database DB1 và DB2 
*/
IF EXISTS(SELECT * FROM SYSOBJECTS WHERE NAME = 'pr_CAU7')
	DROP PROC pr_CAU7
GO
CREATE PROC pr_CAU7
(
	@MSKH		CHAR(10),
	@TENKH		NVARCHAR(100), 
	@DIACHI		NVARCHAR(100), 
	@DIENTHOAI	VARCHAR(10)	
)
AS
BEGIN
	
	INSERT INTO DB2.dbo.KHACHHANG(MSKH,TENKH, DIACHI, DIENTHOAI)
		VALUES(@MSKH,@TENKH, @DIACHI, @DIENTHOAI)
	INSERT INTO DB1.dbo.KHACHHANG(MSKH,TENKH, DIACHI, DIENTHOAI)
		VALUES(@MSKH,@TENKH, @DIACHI, @DIENTHOAI)
END;
GO

exec pr_CAU7 '123', N'Teo', 'HCM', '090386578'

SELECT * FROM DB2.dbo.KHACHHANG
SELECT * FROM DB1.dbo.KHACHHANG


/*
	Câu 8: Tạo Stored Procedure và Trigger xóa khách hàng trên Database DB1, DB2 theo mskh và các hóa đơn liên quan đến khách hàng. 
	Câu 9: Xóa dây chuyền các HOADON có MSHD=5 trên 2 table HOADON và CT_HOADON 
	Câu 10: Hãy làm các công việc 6, 7, 8, 9 tại Server1 và so sánh thời gian thực hiện.
*/

SELECT * FROM DB1.dbo.NHANVIEN
SELECT * FROM DB1.dbo.MATHANG
SELECT * FROM DB1.dbo.KHACHHANG
SELECT * FROM DB1.dbo.CT_HOADON
SELECT * FROM DB1.dbo.HOADON